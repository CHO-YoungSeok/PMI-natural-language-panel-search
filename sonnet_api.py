import anthropic, os, json
from anthropic import AnthropicBedrock

def get_sonnet_client():
    client = AnthropicBedrock(aws_region="ap-southeast-2")
    return client

def preprocess_query(query: str) -> str:
    """
    Claude Sonnet을 사용해 '깔끔문장' 생성
    """
    client = get_sonnet_client()
    
    system_prompt = """당신은 검색 쿼리 전처리 전문가입니다. 
사용자가 입력한 질문을 분석하여 다음 작업을 수행하세요:
- 오타 및 맞춤법 오류 수정
- 명확하고 간결한 검색용 문장으로 변환
- 사용자의 모든 요구조건을 빠짐없이 모두 담아야한다.
- **사용자 입력에 ‘비흡연’, ‘비정상’, ‘非흡연’, ‘non-smoking’, ‘무면허’ 등과 같이 ‘비/非/non/무/불/미 + 단어’ 형태의 표현이 등장하면, 이를 자동으로 ‘흡연을 하지 않는’, ‘정상이 아닌’, ‘면허가 없는’처럼 뒤에 오는 단어의 의미를 부정·반대·결여·제외하는 자연스러운 한국어 문장 또는 구로 풀어서 재표현하라.```
- 20대 와 같이 범위로 나이를 묻는 표현은 "사용자가 나이 범위를 언급하면 다음 단계를 따르세요:
    1. 현재 연도(2025년)를 확인
    2. 나이 범위를 숫자로 변환 (예: "20대" = 20~29세)
    3. 각 나이에서 출생년도 계산 (2025 - 나이)
    4. "출생년도가 YYYY년생~YYYY년생" 형식으로 출력
    처럼 범위로 해석해서 표현할 것.
- 젊은층은 출생년도가 1995년도 이후, 노년층은 출생년도가 1965년 이전으로 해석해서 표현할 것.
- ***반드시 전처리된 문장만 출력하세요. 추가 설명은 하지 마세요.***
"""
      
    user_prompt = f"""다음 쿼리를 전처리하세요.: 원본 쿼리: {query} """
    
    message = client.messages.create(
        model="au.anthropic.claude-sonnet-4-5-20250929-v1:0",
        max_tokens=512,
        system=system_prompt,  # system 파라미터로 전달
        messages=[
            {"role": "user", "content": user_prompt}  # user_prompt 사용
        ]
    )
    
    return message.content[0].text.strip()


def llm_filter_panel(query: str, jsons: list) -> list:
    """
    Sonnet을 사용해서 최종 패널 필터링 및 랭킹
    
    Args:
        query: 사용자 검색 쿼리
        jsons: [{"id": "...", "info": {...}}, ...] 형식의 후보 패널 리스트
    
    Returns:
        필터링되고 랭킹된 패널 리스트 (각 패널의 id를 ' '(공백)로 구분한다)
    """    
    if not jsons:
        return []

    client = get_sonnet_client()
    
    system_prompt = """
당신은 패널들의 설문조사 데이터를 기반으로, 사용자의 검색 쿼리에 가장 잘 맞는 순으로 패널들을 나열하는 AI 어시스턴트입니다.
사용자의 검색 의도를 정확히 파악하고, 관련성 높은 순으로 패널들을 정렬하는 것이 당신의 임무입니다.

# 입력 데이터 설명
- 너에게 주어지는 데이터는 "패널 정보"이며, 각 패널은 다음과 같은 JSON 구조를 가진다.
{
  "id": "패널의 고유 ID (string)",
  "info": {
    "<질문/필드 이름>": "<응답 값>",
    ...
  }
}

# 작업 지시사항
- id 필드는 단순 식별용으로만 사용하며, 의미 판단에는 절대 사용하지 마라.
- 의미 판단과 검색 쿼리 매칭에 사용할 수 있는 정보는 오직 info 내부의 key와 value이며, value를 중심으로 검색 쿼리와의 적합도를 판단하라.
- 검색 쿼리와 가장 관련성이 높은 패널 순으로 정렬해 반환하라.

# 조건 기반 점수 규칙 
- 사용자의 검색 쿼리는 여러 개의 "조건"(예: 지역, 연령, 성별, 행동/경험 등)으로 이루어져 있다.
- 먼저 쿼리에서 이러한 조건들을 스스로 추출하라.
- 각 후보 패널에 대해 info 내부의 모든 key와 value를 읽고, 각 조건에 대해 다음 기준으로 판단하라.
- 조건을 만족하는 명확한 근거가 info 안에 있으면 +1점.
- 조건과 반대되는 근거가 있으면 확실하게 -5점.
- 쿼리에서 중요한 키워드(예: "술을 먹은", "OTT를 이용하는" 등)가 info 어딘가에 전혀 언급되지 않으면, 0점을 주어라.
- 각 패널의 적합도 최종 점수를 계산하라.
- 점수가 높은 패널일수록 검색 쿼리와 더 잘 맞는 것으로 간주하고 상위에 두어라.

# 반환 형식
- 검색 쿼리에 대한 적합도가 높은 순으로 id를 나열하라.
- id만 공백 한 칸으로 구분하여 한 줄로 반환하라. 예시: "w10001 w10023 w10087"
- 다른 설명, 이유, 문장, 마크다운, 따옴표는 절대 포함하지 마라.
- 입력으로 들어온 모든 패널들을 적합도 순으로 정렬하여 하나도 빠짐 없이 반환하라.
"""

    user_prompt = f"""## 검색 쿼리 : ###{query} 에 가장 부합###하는 패널들을 상위로 선별하세요.
    후보 패널 : {jsons}
    """
    
    message = client.messages.create(
        model="global.anthropic.claude-sonnet-4-5-20250929-v1:0",
        max_tokens=2048,
        system=system_prompt,  # system 파라미터로 전달
        messages=[
            {"role": "user", "content": user_prompt}  # user_prompt 사용
        ]
    )
    
    return message.content[0].text.strip()


def extract_result_count(query: str) -> str:
    """
    Claude Sonnet을 사용해 최종 몇 명을 반환할지 추론한다.
    기본 값은 30명이며, 쿼리에 명시적 숫자가 없으면 30을 반환한다.
    """
    client = get_sonnet_client()
    
    system_prompt = """
당신의 역할은 한국어 자연어 검색 쿼리에서
"최종 몇 명의 결과를 반환해야 하는지"를 추출하는 전처리기입니다.
기본 값은 30명이며, 쿼리에 명시적 숫자가 없으면 30을 반환한다.

#규칙:
1. 반드시 하나의 자연수만 출력한다.
2. 자연수 이외의 어떤 문자도 출력하지 않는다.
   - 설명, 단위(명, 개), 마침표, 공백, 개행 모두 금지.
3. 쿼리에 명시된 인원 수 규칙:
   - "10명", "열 명", "상위 5명", "최대 20명", "20명까지만" 등 → 그 숫자를 그대로 사용.
   - "몇 명", "여러 명", "다수", "여러 사람" 등 모호 표현 → 기본값 30으로 처리.
   - 범위가 있는 경우
       · "10~20명", "10-20명" → 상한값(20)을 사용.
       · "최소 3명 이상", "3명 이상 추천" → 명시된 숫자(3)를 사용.
       · "3명에서 5명 정도" → 상한값(5)을 사용.
   - "탑 3", "top 3", "Top3" 등 → 3을 사용.
4. 숫자가 여러 개 등장하면 "결과 개수"와 가장 직접적으로 연결된 숫자를 우선한다.
   - 예: "최근 3개월 활동 기준으로 상위 10명 추천" → 10
5. 쿼리에 "한 명", "1명", "1사람" 등 1명을 의미하는 표현이 있으면 1을 사용.
6. 쿼리에 결과 개수 관련 숫자가 전혀 없으면 30을 출력한다.
7. 자연어 숫자도 인식한다.
   - "한 명, 두 명, 세 명, 네 명, 다섯 명, 여섯 명, 일곱 명, 여덟 명, 아홉 명, 열 명" 등.
8. 검색 결과 개수와 무관한 숫자는 무시한다.
   - 날짜, 연도, 버전, 점수, 금액, 아이디, 페이지 수, 기간 등:
     예: "2024년 데이터로 상위 10명" → 10만 사용.
9. 기본 값은 30명이며, 쿼리에 명시적 숫자가 없거나, 의미를 알 수 없어도 30을 출력한다.

##출력 형식:
- 오직 하나의 양의 정수만 출력한다.
- 공백, 개행, 다른 문자는 일절 포함하지 않는다.
"""

    user_prompt = f"""
다음 쿼리에서 최종 반환해야 할 "명 수"를 위 규칙에 따라 결정하세요.

쿼리: {query}
"""

    message = client.messages.create(
        model="au.anthropic.claude-sonnet-4-5-20250929-v1:0",
        max_tokens=8,
        system=system_prompt,
        messages=[
            {"role": "user", "content": user_prompt}
        ]
    )
    
    return message.content[0].text.strip()
